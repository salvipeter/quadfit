<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Implementation notes</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="implementation-notes">Implementation notes</h1>
<p><img src="example.jpg" alt="Patch example" /></p>
<h2 id="dictionary">Dictionary</h2>
<ul>
<li><p>ribbon: Two cubic B-spline curves (C1, C2) with the same knot
vector along the boundary of the patch. C1 represents the boundary, and
C2 - C1 represents (one-third of) the cross-derivative.</p></li>
<li><p>quad: One four-sided region that will be represented by a single
bi-sextic B-spline surface.</p></li>
<li><p>segment: Splines or polylines (linear splines) forming the quad
boundaries. Between two quads there is only one segment. The orientation
of the segments are arbitrary.</p>
<ul>
<li><p>boundary segment: A segment that is associated with a
ribbon.</p></li>
<li><p>outer segment: A segment that has exactly one end on a
ribbon.</p></li>
<li><p>inner segment: A segment that has no associated ribbon at either
end.</p></li>
</ul></li>
<li><p>vertex: An endpoint of a segment (i.e., a corner vertex of a
quad).</p>
<ul>
<li><p>inner vertex: A vertex that is not on a ribbon.</p></li>
<li><p>side vertex: A vertex that is on exactly one ribbon.</p></li>
<li><p>corner vertex: A vertex that is on two ribbons.</p></li>
</ul></li>
<li><p>local ribbon: A sextic-by-linear B-spline surface representing a
boundary of a quad.</p></li>
<li><p>tangent control point: The second control point on a quad
boundary.</p></li>
<li><p>second derivative control point: The third control point on a
quad boundary.</p></li>
<li><p>twist control point: The second control point on the second
control row of a quad.</p></li>
</ul>
<h2 id="workflow">Workflow</h2>
<p>After reading the PWGB file, a simple topology database is built for
efficient queries, and surface normals and principal curvatures &amp;
directions are fitted at the inner vertices with CGAL jet fitting, using
the supplied sample points.</p>
<ol>
<li><p>Create an initial fit on all quads. This is a simple bicubic
BÃ©zier surface interpolating the vertices and the first derivatives of
the segments. Twists are set up using the parallelogram rule.</p></li>
<li><p>Local ribbons are created along the boundaries by multiplying the
associated part of the ribbon with a scaling function. This scaling
function is computed globally along the whole length of the ribbon,
interpolating the given h-values at the junctions. The local ribbons are
normalized to the [0,1] interval.</p></li>
<li><p>Tangent control points of the cubic patches are updated. Tangents
at corner and side vertices are taken from the associated ribbons.
Tangents at inner vertices are projected into the normal plane (from jet
fitting).</p></li>
<li><p>The cubic patches are degree elevated to quintic, and then the
second derivative control points are updated. At the ends of boundary
segments these are not needed (we already know the local ribbons there,
and the twists control points can also be directly computed from these);
at the ribbon-end of outer segments no change is made (!); and all other
second derivative control points are projected onto a plane that has its
height constrained by the principal curvatures.</p></li>
<li><p>The twist control points are updated. At corner vertices we
already know both ribbons, so a twist is not needed. At side vertices we
take the twist from the associated ribbon; and at inner vertices we
project the twist control point onto a plane that has its height
constrained by the principal curvatures.</p></li>
<li><p>Compute the local ribbons at both outer and inner segments. First
a quartic, two-segment B-spline boundary curve is created from the
already fixed boundary information (end CP, tangent CP, 2nd deriv. CP).
Similarly, on both sides of the segment, a cubic, one-segment B-spline
curve is fit on the second control row (cross derivatives and twists),
into which the same inner knot is inserted (at present this is always
0.5).</p>
<p><em>(TODO: Here we should approximate the boundary and the
normals.)</em></p>
<p>Next, a direction blend is defined by taking the mean of the
cross-derivatives, and a common local ribbon surface is created that
interpolates the boundary, the cross-derivatives at the ends, and the
twists.</p></li>
<li><p>The quintic patches are degree-elevated to sextic. For each quad,
the knot vectors of opposite local ribbons are unified; all inner knots
are also inserted into the sextic surface. Then the control points of
the sextic ribbons are copied into the sextic patch.</p></li>
<li><p><em>(TODO: Here we should approximate the sampled points with the
remaining free control points.)</em></p></li>
</ol>
</body>
</html>
